<?php

class News extends CI_Controller {

    public function __construct() {
        parent::__construct();
        $this->load->library('ion_auth');
        $this->load->library('form_validation');
        $this->load->database();
        $this->load->helper('form');
        $this->load->helper('url');
        $this->lang->load('news');
        $this->load->library('document');
        $this->load->library('pagination');
        $this->load->model('news_model', '', TRUE);
        $this->load->library('session');
        $posts = $this->input->post();
        $this->load->library('user_login');
        $module_name = $this->router->fetch_class();
        $action_name = $this->router->fetch_method();

        if (!$this->user_login->hasPermission($module_name, $action_name)) {
            $this->session->set_flashdata('permission', 'You do not have permission to access this page, please refer to your system administrator.');
            redirect('home');
        }
        if ((!$this->session->userdata('admin_logged')) || (!$this->ion_auth->logged_in())) {
            redirect('login/index/', 'refresh');
        }
    }

    public function index() {

        $this->document->setTitle($this->lang->line('news_title'));

        $this->data['title'] = $this->document->getTitle();

        $this->data['news_title'] = $this->lang->line('news_title');
        $this->data['button_insert'] = $this->lang->line('button_insert');
        $this->data['button_delete'] = $this->lang->line('button_delete');

        $this->data['colum_id'] = $this->lang->line('colum_id');
        $this->data['colum_title'] = $this->lang->line('colum_title');
        $this->data['colum_date'] = $this->lang->line('colum_date');
        $this->data['colum_status'] = $this->lang->line('colum_status');
        $this->data['colum_action'] = $this->lang->line('colum_action');

        $this->data['insert'] = site_url('news/insert');

        $this->data['delete'] = site_url('news/delete');

        $p = $this->uri->segment(3);
        if (isset($p)) {
            $page = $p;
        } else {
            $page = 1;
        }

        $session = $this->session->flashdata('message');
        if (isset($session)) {
            $this->data['success'] = $session;
        } else {
            $this->data['success'] = '';
        }

        $data = array(
            'start' => ($page - 1) * 10,
            'limit' => 10
        );
        $total_news = $this->news_model->totalNews();

        $news = $this->news_model->getNews($data);

        $this->data['news'] = array();
        foreach ($news as $new) {
            $action = array();

            $action[] = array(
                'text' => $this->lang->line('text_edit'),
                'href' => site_url('news/update/' . $new->news_id),
            );

            $this->data['news'][] = array(
                'news_id' => $new->news_id,
                'title' => $new->title,
                'date' => $new->date,
                'status' => $new->status ? $this->lang->line('text_enabled') : $this->lang->line('text_disabled'),
                'selected' => isset($this->input->post['selected']) && in_array($new->news_id, $this->input->post['selected']),
                'action' => $action,
            );
        }

        $pagination = $this->pagination;
        $pagination->total = $total_news;
        $pagination->page = $page;
        $pagination->limit = 5;
        $pagination->url = site_url('currencies/index/' . '{page}');

        $this->data['pagination'] = $pagination->render();

        $this->data['main_content'] = 'news/index.php';

        $this->load->view('main_board', $this->data);
    }

    public function insert() {

        if (($this->input->server('REQUEST_METHOD') === 'POST') && $this->validateForm()) {

            $this->news_model->addNew($this->input->post());

            $this->session->set_flashdata('message', $this->lang->line('text_success'));

            redirect('news/index');
        }
        $this->getForm();
    }

    public function update() {

        if (($this->input->server('REQUEST_METHOD') === 'POST') && $this->validateForm()) {

            $this->news_model->editNew($this->uri->segment(3), $this->input->post());

            $this->session->set_flashdata('message', $this->lang->line('text_success'));

            redirect('news/index');
        }
        $this->getForm();
    }

    public function getForm() {

        $this->document->setTitle($this->lang->line('news_title'));

        $this->data['title'] = $this->document->getTitle();

        $this->data['news_title'] = $this->lang->line('news_title');
        $this->data['text_title'] = $this->lang->line('text_title');
        $this->data['text_short'] = $this->lang->line('text_short');
        $this->data['text_content'] = $this->lang->line('text_content');
        $this->data['text_status'] = $this->lang->line('text_status');
        $this->data['text_date'] = $this->lang->line('text_date');
        $this->data['text_path'] = $this->lang->line('text_path');
        $this->data['text_is_new'] = $this->lang->line('text_is_new');
        $this->data['text_type'] = $this->lang->line('text_type');
        $this->data['text_enabled'] = $this->lang->line('text_enabled');
        $this->data['text_disabled'] = $this->lang->line('text_disabled');
        $this->data['button_save'] = $this->lang->line('button_save');
        $this->data['button_cancel'] = $this->lang->line('button_cancel');

        $id = $this->uri->segment(3);

        if ($id) {
            $this->data['action'] = site_url('news/update/' . $id);
        } else {
            $this->data['action'] = site_url('news/insert');
        }

        $this->data['cancel'] = site_url('news');

        if ($id && ($this->input->server('REQUEST_METHOD') != 'POST')) {
            $new_info = $this->news_model->getNew($id);
        }
        if (isset($posts['title'])) {
            $this->data['title'] = $posts['title'];
        } elseif (!empty($new_info)) {
            $this->data['title'] = $new_info->title;
        } else {
            $this->data['title'] = '';
        }
        if (isset($posts['description'])) {
            $this->data['description'] = $posts['description'];
        } elseif (!empty($new_info)) {
            $this->data['description'] = html_entity_decode($new_info->description);
        } else {
            $this->data['description'] = '';
        }
        if (isset($posts['file_path'])) {
            $this->data['file_path'] = $posts['file_path'];
        } elseif (!empty($new_info)) {
            $this->data['file_path'] = $new_info->file_path;
        } else {
            $this->data['file_path'] = '';
        }
        if (isset($posts['status'])) {
            $this->data['status'] = $posts['status'];
        } elseif (!empty($new_info)) {
            $this->data['status'] = $new_info->status;
        } else {
            $this->data['status'] = 0;
        }
        if (isset($posts['type'])) {
            $this->data['type'] = $posts['type'];
        } elseif (!empty($new_info)) {
            $this->data['type'] = $new_info->type;
        } else {
            $this->data['type'] = 0;
        }
        $this->data['main_content'] = 'news/form.php';

        $this->load->view('main_board', $this->data);
    }

    public function delete() {
        $select = $this->input->post('selected');
        if (!empty($select)) {
            foreach ($select as $id) {
                $this->news_model->deleteNew($id);
                $this->session->set_flashdata('message', $this->lang->line('text_success'));
            }
        } else {
            $this->session->set_flashdata('message', $this->lang->line('text_no_check'));
        }
        redirect('news');
    }

    private function validateForm() {
        $this->form_validation->set_rules('title', 'lang:error_title', 'required|trim|xss_clean|min_length[6]');
        if ($this->form_validation->run() == TRUE) {
            return true;
        } else {
            return false;
        }
    }

}

?>
