<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

class User extends CI_Controller {

    var $id;
    var $name;
    var $active;
    var $user;
    var $data;

    function __construct() {
        parent::__construct();
        $this->load->library('ion_auth');
        $this->load->library('encryption');
        $this->load->library('session');
        $this->load->library('form_validation');
        $this->load->database();
        $this->load->library('document');
        $this->load->helper('form');
        $this->load->helper('url');
        $this->lang->load('user');
        $this->load->library('pagination');
        $this->load->model('user_model', '', TRUE);
        $this->load->library('user_login');
        $module_name = $this->router->fetch_class();
        $action_name = $this->router->fetch_method();

        if (!$this->user_login->hasPermission($module_name, $action_name)) {
            $this->session->set_flashdata('permission', 'You do not have permission to access this page, please refer to your system administrator.');
            redirect('home');
        }
        $posts = $this->input->post();

        if ((!$this->session->userdata('admin_logged')) || (!$this->ion_auth->logged_in())) {
            redirect('login/index/', 'refresh');
        }
    }

    public function index() {
        $p = $this->uri->segment(3);
        if (isset($p)) {
            $page = $this->uri->segment(3);
        } else {
            $page = 1;
        }

        $this->document->setTitle($this->lang->line('user_title'));

        $this->data['title'] = $this->document->getTitle();

        $this->data['headding_title'] = $this->lang->line('user_title');
        $this->data['colum_firstname'] = $this->lang->line('colum_firstname');
        $this->data['colum_lastname'] = $this->lang->line('colum_lastname');
        $this->data['colum_number'] = $this->lang->line('colum_number');
        $this->data['colum_name'] = $this->lang->line('colum_name');
        $this->data['colum_date'] = $this->lang->line('colum_date');
        $this->data['colum_action'] = $this->lang->line('colum_action');
        $this->data['text_view'] = $this->lang->line('text_view');
        $this->data['text_keyword'] = $this->lang->line('text_keyword');
        $this->data['button_search'] = $this->lang->line('button_search');

        $post = $this->input->post();
        if (isset($post['filter_account_number'])) {
            $filter_account_number = $post['filter_account_number'];
        } else {
            $filter_account_number = '';
        }
        if (isset($post['filter_name'])) {
            $filter_name = $post['filter_name'];
        } else {
            $filter_name = '';
        }
        if ($this->input->post('filter_account_number') || $this->input->post('filter_name')) {
            $data = array(
                'filter_account_number' => $filter_account_number,
                'filter_name' => $filter_name,
                'start' => ($page - 1) * 5,
                'limit' => 5
            );
            $total_users = $this->user_model->totalUsers();

            $users = $this->user_model->getUsers($data);

            $this->data['users'] = array();

            $this->data['delete'] = site_url('user/delete');

            foreach ($users as $user) {
                if ($user->id) {
                    $edit = site_url('user/update/' . $user->id);
                }
                $this->data['add_new'] = site_url('user/insert');

                $date = gmdate('Y-m-d H:i:s', $user->created_on);

                $this->data['users'][] = array(
                    'id' => $user->id,
                    'first_name' => $user->first_name,
                    'last_name' => $user->last_name,
                    'account_number' => $user->account_number,
                    'username' => $user->username,
                    'created_on' => $date,
                    'edit' => $edit,
                    'selected' => isset($this->input->post['selected']) && in_array($user->id, $this->input->post['selected']),
                );
            }
            $pagination = $this->pagination;
            $pagination->total = $total_users;
            $pagination->page = $page;
            $pagination->limit = 5;
            $pagination->url = site_url('user/index/' . '{page}');

            $this->data['pagination'] = $pagination->render();

            $this->data['main_content'] = 'user/index.php';

            $this->load->view('main_board', $this->data);
        } else {
            $data = array(
                'filter_account_number' => $filter_account_number,
                'filter_name' => $filter_name,
                'start' => ($page - 1) * 5,
                'limit' => 5
            );
            $total_users = $this->user_model->totalUsers();

            $users = $this->user_model->getUsers($data);

            $this->data['users'] = array();

            $this->data['delete'] = site_url('user/delete');

            $session = $this->session->flashdata('message');
            if (isset($session)) {
                $this->data['success'] = $session;
            } else {
                $this->data['success'] = '';
            }

            foreach ($users as $user) {
                if ($user->id) {
                    $edit = site_url('user/update/' . $user->id);
                }
                $this->data['add_new'] = site_url('user/insert');

                $date = gmdate('Y-m-d H:i:s', $user->created_on);

                $this->data['users'][] = array(
                    'id' => $user->id,
                    'first_name' => $user->first_name,
                    'last_name' => $user->last_name,
                    'account_number' => $user->account_number,
                    'username' => $user->username,
                    'created_on' => $date,
                    'edit' => $edit,
                    'selected' => isset($this->input->post['selected']) && in_array($user->id, $this->input->post['selected']),
                );
            }
            $pagination = $this->pagination;
            $pagination->total = $total_users;
            $pagination->page = $page;
            $pagination->limit = 5;
            $pagination->url = site_url('user/index/' . '{page}');

            $this->data['pagination'] = $pagination->render();

            $this->data['main_content'] = 'user/index.php';

            $this->load->view('main_board', $this->data);
        }
    }

    public function update() {
        if (($this->input->server('REQUEST_METHOD') === 'POST') && $this->validateForm()) {
            $this->user_model->update($this->uri->segment(3), $this->input->post());

            $this->session->set_flashdata('message', $this->lang->line('text_success'));

            redirect('user/index');
        }
        $this->getForm();
    }

    public function getForm() {

        $this->document->setTitle($this->lang->line('user_title'));

        $this->data['title'] = $this->document->getTitle();

        $this->data['user_title'] = $this->lang->line('user_title');
        $this->data['text_email'] = $this->lang->line('text_email');
        $this->data['text_fn'] = $this->lang->line('text_fn');
        $this->data['text_ln'] = $this->lang->line('text_ln');
        $this->data['text_company'] = $this->lang->line('text_company');
        $this->data['text_phone'] = $this->lang->line('text_phone');
        $this->data['text_mobile'] = $this->lang->line('text_mobile');
        $this->data['text_master'] = $this->lang->line('text_master');
        $this->data['text_login_pin'] = $this->lang->line('text_login_pin');
        $this->data['button_save'] = $this->lang->line('button_save');
        $this->data['button_cancel'] = $this->lang->line('button_cancel');

        $id = $this->uri->segment(3);

        if ($id) {
            $this->data['action'] = site_url('user/update/' . $id);
        }

        $this->data['cancel'] = site_url('user/index');

        if (isset($id) && ( $this->input->server('REQUEST_METHOD') != 'POST')) {
            $user_info = $this->user_model->getUser($id);
        }

        if (isset($posts['email'])) {
            $this->data['email'] = $posts['email'];
        } elseif (!empty($user_info)) {
            $this->data['email'] = $user_info->email;
        } else {
            $this->data['email'] = '';
        }
        if (isset($posts['first_name'])) {
            $this->data['first_name'] = $posts['first_name'];
        } elseif (!empty($user_info)) {
            $this->data['first_name'] = $user_info->first_name;
        } else {
            $this->data['first_name'] = '';
        }
        if (isset($posts['last_name'])) {
            $this->data['last_name'] = $posts['last_name'];
        } elseif (!empty($user_info)) {
            $this->data['last_name'] = $user_info->last_name;
        } else {
            $this->data['last_name'] = '';
        }
        if (isset($posts['phone'])) {
            $this->data['phone'] = $posts['phone'];
        } elseif (!empty($user_info)) {
            $this->data['phone'] = $user_info->phone;
        } else {
            $this->data['phone'] = '';
        }
        if (isset($posts['mobile'])) {
            $this->data['mobile'] = $posts['mobile'];
        } elseif (!empty($user_info)) {
            $this->data['mobile'] = $user_info->mobile;
        } else {
            $this->data['mobile'] = '';
        }
        if (isset($posts['company'])) {
            $this->data['company'] = $posts['company'];
        } elseif (!empty($user_info)) {
            $this->data['company'] = $user_info->company;
        } else {
            $this->data['company'] = '';
        }

        $this->data['main_content'] = 'user/form.php';

        $this->load->view('main_board', $this->data);
    }

    public function view() {

        $this->data['text_details'] = $this->lang->line('text_details');
        $this->data['text_acc_number'] = $this->lang->line('text_acc_number');
        $this->data['text_type'] = $this->lang->line('text_type');
        $this->data['text_first'] = $this->lang->line('text_first');
        $this->data['text_last'] = $this->lang->line('text_last');
        $this->data['text_acc_name'] = $this->lang->line('text_acc_name');
        $this->data['text_sign_date'] = $this->lang->line('text_sign_date');
        $this->data['text_brithday'] = $this->lang->line('text_brithday');
        $this->data['text_email'] = $this->lang->line('text_email');
        $this->data['text_welcome'] = $this->lang->line('text_welcome');
        $this->data['text_company'] = $this->lang->line('text_company');
        $this->data['text_phone'] = $this->lang->line('text_phone');
        $this->data['text_mobile'] = $this->lang->line('text_mobile');
        $this->data['text_address'] = $this->lang->line('text_address');
        $this->data['text_city'] = $this->lang->line('text_city');
        $this->data['text_state'] = $this->lang->line('text_state');
        $this->data['text_country'] = $this->lang->line('text_country');
        $this->data['text_zip_code'] = $this->lang->line('text_zip_code');
        $this->data['text_security_que'] = $this->lang->line('text_security_que');
        $this->data['text_answer'] = $this->lang->line('text_answer');
        $this->data['text_count'] = $this->lang->line('text_count');
        $this->data['text_infor'] = $this->lang->line('text_infor');
        $this->data['button_close'] = $this->lang->line('button_close');

        $id = $this->uri->segment(3);

        if ($id) {
            $user_info = $this->user_model->getUser($id);
            $this->data['id'] = $user_info->id;
            $this->data['account_number'] = $user_info->account_number;
            $this->data['account_type'] = $user_info->account_type;
            $this->data['first_name'] = $user_info->first_name;
            $this->data['last_name'] = $user_info->last_name;
            $this->data['username'] = $user_info->username;
            $this->data['created_on'] = gmdate('Y-m-d H:i:s', $user_info->created_on);
            $this->data['dob'] = $user_info->dob;
            $this->data['email'] = $user_info->email;
            $this->data['welcome_message'] = $user_info->welcome_message;
            $this->data['company'] = $user_info->company;
            $this->data['phone'] = $user_info->phone;
            $this->data['mobile'] = $user_info->mobile;
            $this->data['address'] = $user_info->address;
            $this->data['city'] = $user_info->city;
            $this->data['state'] = $user_info->state;
            $this->data['country'] = $user_info->country;
            $this->data['postcode'] = $user_info->postcode;
            $this->data['security_question'] = $user_info->security_question;
            $this->data['security_answer'] = $user_info->security_answer;
            $this->data['referral_count'] = $user_info->referral_count;
            $this->data['additional_infor'] = $user_info->additional_infor;
            $this->load->view('user/view', $this->data);
        }
    }

    private function validateForm() {
        if ($this->input->post('old_email') != $this->input->post('email')) {
            $this->form_validation->set_rules('email', 'lang:error_email', 'required|xss_clean|valid_email|max_length[64]|callback_check_email');
            if ($this->form_validation->run() == TRUE) {
                return true;
            } else {
                return false;
            }
        }
        return true;
    }

    public function check_email($email) {
        if ($this->user_model->check_email($email)) {
            $this->form_validation->set_message('check_email', 'E-mail already. Please add new email');
            return FALSE;
        } else {
            return TRUE;
        }
    }

}